const request = require('request')

// Install the module before run de script
// from the root directory run:
// npm install --save request

// command to execute de script:
// node .\example\server\pushFCM-RequestApi.js

const registration_token = '<Token generated by your test device>'

const sendNotifications = (data) => {

  const dataString = JSON.stringify(data)

  const headers = {
    'Authorization': 'key=API_KEY_GOES_HERE',
    'Content-Type': 'application/json'
  }

  const options = {
    uri: 'https://fcm.googleapis.com/fcm/send',
    method: 'POST',
    headers: headers,
    json: data
  }

  request(options, function (err, res, body) {
    if (err) throw err
    else console.log({ 'answer of server:': body })
  })
}

const sendToDevice = (msg, title, device) => {

  const data = {
    "data": {
      "body": msg,
      "title": title
    },
    'to': device
  }

  sendNotifications(data)
}

const sendToAll = (msg, title, regIdArray) => {

  const data = {
    "data": {
      "body": msg,
      "title": title
    }
  }

  const folds = regIdArray.length % 1000

  for (let i = 0; i < folds; i++) {
    let start = i * 1000,
      end = (i + 1) * 1000

    data['registration_ids'] = regIdArray.slice(start, end).map((item) => {
      return item['token']
    })

    console.log({ data });

    sendNotifications(data)
  }
}

const configAndSendTestMessage = () => {
  let msg = 'NodeJS says:',
    title = 'Push with NodeJS works well!',
    devices = [registration_token]

  sendToDevice(msg, title, registration_token)
}

configAndSendTestMessage()
